<!DOCTYPE html>
<html>
<head>
<style>
	
</style> 
</head>
<body> 

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type = "module">


import * as THREE from 'https://unpkg.com/three/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three/examples/jsm/controls/OrbitControls.js';
import { MTLLoader } from 'https://unpkg.com/three/examples/jsm/loaders/MTLLoader.js';
import { OBJLoader } from 'https://unpkg.com/three/examples/jsm/loaders/OBJLoader.js';


var renderer, scene, camera, controls;
var sceneHUD, cameraHUD;
<<<<<<< HEAD
var aframe, whRatio, halfH, halfW;
=======
var aframe, whRatio, halfH, halfW, gun, frontSight, bullets, bulletsMove;
>>>>>>> master
init();
animate();

function init() {

	scene = new THREE.Scene();

  	camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  	camera.position.z = 200;
  	cameraHUD = new THREE.OrthographicCamera(-10, 10, 10, -10, -10, 1000);
  	cameraHUD.position.z = 200;

  	renderer = new THREE.WebGLRenderer();
  	renderer.setSize(window.innerWidth, window.innerHeight);
  	renderer.setClearColor(0x888888);
  	document.body.appendChild(renderer.domElement);
  	let controls = new OrbitControls(camera, renderer.domElement);
  	controls.autoRotate = true;
  	
  	 var light = new THREE.PointLight(0xffffff);
  	light.position.set(100, 300, 200);
  	scene.add(light);

  	var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
  	scene.add(gridXZ);

  	window.addEventListener('resize', onWindowResize, false);

<<<<<<< HEAD
=======
	bullets = [];
	bulletsMove = [];
>>>>>>> master
  
  /////////////////////////////////////////////////////////////////////
	var cube1 = new THREE.Mesh(new THREE.BoxGeometry(20, 20, 20),
    new THREE.MeshLambertMaterial({
    	color: 0xff1234
    }));
<<<<<<< HEAD
  	cube1.position.x = -60;
=======
  	cube1.position.x = 0;
>>>>>>> master
  	scene.add(cube1);
  	

  	var cube2 = cube1.clone();
  	cube2.material = new THREE.MeshLambertMaterial({
  		color: 0x2134ff
  	});
  	cube2.position.x = 60;
  	scene.add(cube2);
<<<<<<< HEAD
=======
  	
  	
>>>>>>> master

  //////////////////////////////////////////////////////////
  	renderer.autoClear = false;
  	sceneHUD = new THREE.Scene();

  	whRatio = window.innerWidth / window.innerHeight;
  	halfH = 10;
  	halfW = whRatio * halfH;

  	aframe = new THREE.Group();

	let loader = new THREE.TextureLoader();
  	loader.crossOrigin = '';
<<<<<<< HEAD
  	var texture = loader.load('https://i.imgur.com/AzJquZI.png');
=======
  	var texture = loader.load('https://i.imgur.com/upJ8Uet.png');
>>>>>>> master
  	var texMat = new THREE.MeshBasicMaterial({
    	map: texture,
    	alphaTest: 0.5,
    	side: THREE.DoubleSide
  	});
<<<<<<< HEAD

  	let fframe = new THREE.Mesh(new THREE.PlaneGeometry(5, 5), texMat);
	fframe.position.set(5, 0, 0);
=======
  	gun = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), texMat);

>>>>>>> master
	loader = new THREE.TextureLoader();
  	loader.crossOrigin = '';
  	var texture = loader.load('https://i.imgur.com/vBTTePp.png');
  	var texMat = new THREE.MeshBasicMaterial({
    	map: texture,
    	alphaTest: 0.5,
    	side: THREE.DoubleSide
  	});
<<<<<<< HEAD
  	let button = new THREE.Mesh(new THREE.CircleGeometry(halfW / 15, 30), texMat);

  	sceneHUD.add(aframe)
  	aframe.add(fframe);
  	aframe.add(button)
  	aframe.position.set(0, -(halfH - halfW / 10), 0)
  
=======
  	
	frontSight = new THREE.Mesh(new THREE.CircleGeometry(halfW / 15, 30), texMat);
	frontSight.position.set(0, 2, 0);
	gun.position.set(3, 0, 0);

  	sceneHUD.add(aframe)
  	aframe.add(gun);
  	aframe.add(frontSight)
  	aframe.position.set(0, -(halfH - halfW / 10), 0)
  	camera.lookAt(aframe.position);
>>>>>>> master
  	document.addEventListener('mousedown', hudButtonPick, false);
}

function onWindowResize() {
	// renderer resize
	
  	renderer.setSize(window.innerWidth, window.innerHeight);
   whRatio = window.innerWidth / window.innerHeight;

	// perspective camera resize
  camera.aspect = whRatio;
  camera.updateProjectionMatrix();

	// orthographic camera resize
  halfH = 20;
  halfW = halfH * whRatio;

  cameraHUD.left = -halfW;
  cameraHUD.right = halfW;
  cameraHUD.top = halfH;
  cameraHUD.bottom = -halfH;
  cameraHUD.updateProjectionMatrix();

	// HUD geometry relatively resized & placed 
  aframe.position.set(0, -(halfH - halfW / 10), 0)
  aframe.children[0].geometry = new THREE.PlaneGeometry(2 * halfW, 2 * halfW / 10);
  aframe.children[1].geometry = new THREE.CircleGeometry(halfW / 15, 30)
}

function hudButtonPick (event) {
	// convert to NDC
	let ndcX = (event.clientX / window.innerWidth) * 2 - 1;
  let ndcY = -(event.clientY / window.innerHeight) * 2 + 1;

	// convert to HUD scene coordinate
  let halfW = cameraHUD.right;
  let halfH = cameraHUD.top;
  let xx = ndcX * halfW;
  let yy = ndcY * halfH;

	// button location: (0, - (halfH- halfW/10))
  let buttonCenter = new THREE.Vector2 (0, -(halfH-halfW/10));
  let mouse = new THREE.Vector2 (xx, yy);
  if (mouse.distanceTo (buttonCenter) < halfW/15) 
  	console.log ('hit')
  else
  	console.log ('miss')

}

<<<<<<< HEAD
=======
function setEventsMouse(){
	window.addEventListener( 'click', function(e){
		if(e.button===0){
			var geometry = new THREE.CylinderGeometry( 1, 1, 3, 64 );
			var material = new THREE.MeshBasicMaterial( {color: 0xffd700} );
			var bullet = new THREE.Mesh( geometry, material );
			bullet.rotation.y = Math.PI/2;
			scene.add( bullet );
			bullet,position.set(camera.lookAt(Mesh.position));
			bullet.position.z--;
		}
	});
}

window.addEventListener("keydown", checkKeyPressed, false);
function checkKeyPressed(e) {
	var oldPos = frontSight.position.clone();
	if (e.keyCode == 65) {
    	frontSight.position.x -= 1;
		var newPos = frontSight.position.clone();
		updateGun(oldPos, newPos);
	}
	if (e.keyCode == 68) {
    	frontSight.position.x += 1;
		var newPos = frontSight.position.clone();
		updateGun(oldPos, newPos);
	}
	if (e.keyCode == 83) {
    	frontSight.position.y -= 1;
		var newPos = frontSight.position.clone();
		updateGun(oldPos, newPos);
	}
	if (e.keyCode == 87) {
    	frontSight.position.y += 1;
		var newPos = frontSight.position.clone();
		updateGun(oldPos, newPos);
	}
	if (e.keyCode == 32) {
    	shooting();
	}
};

function updateGun(oldPos, newPos) {
	oldPos = oldPos.clone().sub(gun.position);
	newPos = newPos.clone().sub(gun.position);
	// console.log("o:"+oldPos+"n"+newPos);
	console.log(oldPos);
	console.log(newPos);
	var oldAngle = Math.atan2(oldPos.x, oldPos.y);
	var newAngle = Math.atan2(newPos.x, newPos.y);
	var delta = newAngle - oldAngle;
	console.log(delta);
	gun.rotation.z -= delta;
}

function shooting() {
	var lookAtVector = new THREE.Vector3(0,0, -1);
	lookAtVector.applyQuaternion(camera.quaternion);
	var geometry = new THREE.CylinderGeometry( 1, 1, 1, 64 );
	var material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
	var bullet = new THREE.Mesh( geometry, material );
	bullet.rotation.x = Math.PI/2;
	scene.add(bullet);

	bullet.position.set(camera.position.x, camera.position.y, camera.position.z);
	var startPos = new THREE.Vector3();
	frontSight.getWorldPosition(startPos);
	console.log(startPos);
	bullet.position.add(startPos);
	bullets.push(bullet);
	bulletsMove.push(lookAtVector.clone());
}

function updateBullet() {
	for(var i=0; i<bullets.length; i++){
		bullets[i].position.add(bulletsMove[i]);
	}
}



>>>>>>> master
function animate() {

	renderer.clear(true);
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
  renderer.render(sceneHUD, cameraHUD);
<<<<<<< HEAD

=======
	updateBullet();
>>>>>>> master
}

</script>

</body>
</html>